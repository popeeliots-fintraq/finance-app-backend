# .github/workflows/ci.yml
name: Python Backend CI/CD (Fin-Traq V2)

on:
  push:
    # Trigger deployment only on the main branch after tests pass
    branches: [ "main" ]
  # Run tests on Pull Requests against main
  pull_request:
    branches: [ "main" ]
  # Allow manual runs from the GitHub Actions tab
  workflow_dispatch:

env:
  # === Fin-Traq V2 Deployment Configuration (CONFIRMED VALUES) ===
  PROJECT_ID: popeeliots-fintraq
  SERVICE_NAME: fintraq-backend
  REGION: us-central1
  
  # Artifact Registry Config
  ARTIFACT_REGISTRY: fintraq-backend
  IMAGE_NAME: fintraq-backend-v2-image
  # ==========================================================

jobs:
  # ---------------------
  # 1. CONTINUOUS INTEGRATION: Test, Lint, and Structural Check
  # ---------------------
  test-and-lint:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Python 3.11
        uses: actions/setup-python@v4
        with:
          python-version: "3.11"
          cache: 'pip'

      - name: Install Dependencies & Quality Tools
        run: |
          python -m pip install --upgrade pip
          # Ensure all necessary production and testing dependencies are installed
          pip install -r requirements.txt
          pip install flake8
      
      # NOTE: Your existing Flake8 and Python checks are here.
      - name: Run Flake8 Linter Check
        run: |
          flake8 . --count --select=E9,F63,F7,F82 --show-source --statistics
          flake8 . --count --exit-zero --max-complexity=10 --max-line-length=120 --statistics
          
      # âš ï¸ CRITICAL FIX: The old test for 'db.base' must be updated or removed, 
      # as your SQL ORM structure is gone.
      - name: Check for Core Schema Files (Migration Safety Check)
        run: |
          # ðŸš¨ FIX: Replaced the failing SQL import check with a file system check.
          # We should remove this step entirely once all SQL files are deleted.
          echo "Checking for old SQL models to ensure deletion..."
          ls db/base.py 2> /dev/null && { echo "ERROR: Old db/base.py found. Migration is incomplete."; exit 1; } || echo "db/base.py is gone or correctly removed."
          
      - name: Basic API Health Check
        run: echo "Code quality check passed. Proceeding to deployment."

  # ---------------------
  # 2. CONTINUOUS DEPLOYMENT: Build, Push, and Deploy to Cloud Run
  # ---------------------
  deploy:
    # This job will only run if the 'test-and-lint' job is successful
    needs: test-and-lint
    
    # Only run the deploy job on pushes to the 'main' branch, not PRs
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    
    runs-on: ubuntu-latest
    
    # Required permission for workload identity federation
    permissions:
      contents: 'read'
      id-token: 'write'
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      # 1. Authenticate to Google Cloud
      - name: 'Authenticate to GCP'
        id: auth
        uses: 'google-github-actions/auth@v2'
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      # 2. Configure Docker for Artifact Registry
      - name: 'Configure Docker for Artifact Registry'
        run: gcloud auth configure-docker ${{ env.REGION }}-docker.pkg.dev

      # 3. Build and Push the Docker Image
      - name: Build and Push Docker Image
        run: |
          FULL_IMAGE_NAME=${{ env.REGION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/${{ env.ARTIFACT_REGISTRY }}/${{ env.IMAGE_NAME }}:${{ github.sha }}
          docker build -t $FULL_IMAGE_NAME .
          docker push $FULL_IMAGE_NAME
          echo "IMAGE_URL=$FULL_IMAGE_NAME" >> $GITHUB_ENV
          
      # 4. Deploy to Google Cloud Run
      - name: Deploy to Cloud Run
        uses: google-github-actions/deploy-cloudrun@v2
        with:
          service: ${{ env.SERVICE_NAME }}
          region: ${{ env.REGION }}
          image: ${{ env.IMAGE_URL }}

          # ==========================================================
          # ðŸŒŸ CRITICAL FIX: Pass the Supabase Connection URL securely
          # ==========================================================
          env_vars: |
            DATABASE_URL=${{ secrets.DATABASE_URL }}
            ML_EFS_ENABLED=true
            ML_WEIGHTS_VERSION=v2.0
            FIN_TRAQ_API_KEY=${{ secrets.FIN_TRAQ_API_KEY }}
          
          # Setting the Uvicorn command - RETAINED
          entrypoint: uvicorn
          args: |
            ["app:app", "--host", "0.0.0.0", "--port", "$PORT", "--log-level", "info"]
            
          # Use the 'flags' input for custom gcloud run flags - RETAINED
          flags: --no-allow-unauthenticated
